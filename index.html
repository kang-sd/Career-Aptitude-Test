
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CAREER · 진로직업 성향 분석</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&family=Noto+Serif+KR:wght@300;400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg:      #faf8f4;
      --surface: #ffffff;
      --ink:     #1a1612;
      --ink2:    #4a4540;
      --gold:    #b8903a;
      --gold2:   #d4aa5a;
      --gold-bg: #fdf6e9;
      --border:  #e8e2d8;
      --accent:  #8b6914;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: var(--bg); color: var(--ink); font-family: 'Noto Serif KR', serif; min-height: 100vh; }

    .top-bar { height: 4px; background: linear-gradient(90deg, var(--gold), var(--gold2), var(--gold)); }
    .container { max-width: 780px; margin: 0 auto; padding: 0 24px 80px; }

    /* 헤더 */
    .header { text-align: center; padding: 52px 0 44px; animation: fadeDown 0.8s ease both; }
    .header-eyebrow { font-size: 10px; letter-spacing: 5px; text-transform: uppercase; color: var(--gold); margin-bottom: 18px; }
    .header h1 { font-family: 'Cormorant Garamond', serif; font-size: clamp(48px, 10vw, 84px); font-weight: 300; font-style: italic; color: var(--ink); line-height: 0.95; letter-spacing: -2px; cursor: pointer; }
    .header h1 span { color: var(--gold); }
    .header-rule { width: 50px; height: 1px; background: linear-gradient(90deg, transparent, var(--gold), transparent); margin: 22px auto 18px; }
    .header-sub { font-size: 13px; color: var(--ink2); }

    /* 안내 카드 */
    .intro-cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1px; background: var(--border); border: 1px solid var(--border); margin-bottom: 44px; animation: fadeUp 0.8s 0.2s ease both; }
    .intro-card { background: var(--surface); padding: 24px 18px; text-align: center; }
    .intro-card-num { font-family: 'Cormorant Garamond', serif; font-size: 38px; font-weight: 300; color: var(--gold); line-height: 1; margin-bottom: 6px; }
    .intro-card-title { font-size: 9px; letter-spacing: 3px; text-transform: uppercase; color: var(--gold); margin-bottom: 8px; }
    .intro-card p { font-size: 12px; color: var(--ink2); line-height: 1.6; }

    /* 이름 입력 */
    .name-section { margin-bottom: 36px; animation: fadeUp 0.8s 0.3s ease both; }
    .section-label { font-size: 10px; letter-spacing: 4px; text-transform: uppercase; color: var(--gold); margin-bottom: 10px; }
    .name-row { display: flex; gap: 10px; }
    .name-input { flex: 1; background: var(--surface); border: 1px solid var(--border); color: var(--ink); font-family: 'Noto Serif KR', serif; font-size: 16px; padding: 14px 18px; outline: none; transition: border-color 0.25s; }
    .name-input:focus { border-color: var(--gold); }
    .name-input::placeholder { color: #bbb; }
    .btn-search { background: var(--surface); border: 1px solid var(--gold); color: var(--gold); font-family: 'Cormorant Garamond', serif; font-size: 15px; letter-spacing: 2px; padding: 14px 26px; cursor: pointer; transition: all 0.25s; white-space: nowrap; }
    .btn-search:hover { background: var(--gold); color: #fff; }

    /* 확인 다이얼로그 */
    .confirm-box { background: var(--gold-bg); border: 1px solid rgba(184,144,58,0.3); padding: 22px 24px; margin-bottom: 28px; animation: fadeUp 0.3s ease; }
    .confirm-box p { font-size: 15px; color: var(--ink); margin-bottom: 16px; line-height: 1.7; }
    .confirm-btns { display: flex; gap: 10px; }
    .btn-yes { background: var(--gold); border: none; color: #fff; font-family: 'Noto Serif KR', serif; font-size: 14px; padding: 11px 26px; cursor: pointer; transition: opacity 0.2s; }
    .btn-yes:hover { opacity: 0.85; }
    .btn-no { background: transparent; border: 1px solid var(--border); color: var(--ink2); font-family: 'Noto Serif KR', serif; font-size: 14px; padding: 11px 26px; cursor: pointer; transition: all 0.2s; }
    .btn-no:hover { border-color: var(--ink2); color: var(--ink); }

    /* 진행 바 */
    .progress-wrap { position: sticky; top: 0; z-index: 10; background: var(--bg); padding: 10px 0 14px; border-bottom: 1px solid var(--border); margin-bottom: 8px; }
    .progress-bar-bg { height: 2px; background: var(--border); position: relative; }
    .progress-bar-fill { position: absolute; inset: 0; background: linear-gradient(90deg, var(--gold), var(--gold2)); transform-origin: left; transform: scaleX(0); transition: transform 0.3s ease; }
    .progress-text { font-size: 11px; letter-spacing: 1px; color: var(--ink2); text-align: right; margin-top: 6px; }

    /* 문항 구분선 */
    .questions-header { display: flex; align-items: center; gap: 18px; margin-bottom: 8px; }
    .questions-header-line { flex: 1; height: 1px; background: var(--border); }
    .questions-header-text { font-size: 10px; letter-spacing: 4px; text-transform: uppercase; color: var(--gold); }

    /* 문항 */
    .q-card { background: var(--surface); border: 1px solid var(--border); padding: 32px 28px; margin-bottom: 16px; animation: fadeUp 0.3s ease both; }
    .q-num { font-family: 'Cormorant Garamond', serif; font-size: 14px; color: var(--gold); margin-bottom: 12px; }
    .q-text { font-size: 17px; line-height: 1.7; color: var(--ink); margin-bottom: 18px; }
    .q-options { display: flex; gap: 8px; }
    .q-option { flex: 1; background: var(--bg); border: 1px solid var(--border); color: var(--ink2); font-size: 13px; padding: 12px 0; text-align: center; cursor: pointer; transition: all 0.2s; }
    .q-option:hover { border-color: var(--gold); background: var(--gold-bg); }
    .q-option.selected { background: var(--gold); border-color: var(--gold); color: #fff; }

    /* 제출 버튼 */
    .submit-wrap { text-align: center; padding: 48px 0; }
    .btn-submit { background: var(--gold); border: none; color: #fff; font-family: 'Noto Serif KR', serif; font-size: 17px; padding: 16px 52px; cursor: pointer; transition: opacity 0.2s; }
    .btn-submit:hover { opacity: 0.85; }
    .btn-submit:disabled { opacity: 0.4; cursor: not-allowed; }

    /* 결과 화면 */
    .result-header { text-align: center; padding: 48px 0 38px; }
    .result-header h2 { font-family: 'Cormorant Garamond', serif; font-size: 52px; font-weight: 300; font-style: italic; color: var(--ink); }
    .result-header h2 span { color: var(--gold); }
    .result-header-rule { width: 80px; height: 1px; background: linear-gradient(90deg, transparent, var(--gold), transparent); margin: 18px auto; }
    .result-name { font-size: 16px; color: var(--ink2); }

    .chart-box { background: var(--surface); border: 1px solid var(--border); padding: 36px 28px; margin-bottom: 32px; }
    .chart-title { font-size: 11px; letter-spacing: 3px; text-transform: uppercase; color: var(--gold); text-align: center; margin-bottom: 24px; }

    .type-list { display: grid; gap: 14px; margin-bottom: 32px; }
    .type-item { background: var(--surface); border: 1px solid var(--border); padding: 22px; }
    .type-item.top { border-color: var(--gold); background: var(--gold-bg); }
    .type-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .type-item-name { font-size: 16px; font-weight: 600; color: var(--ink); }
    .type-item.top .type-item-name { color: var(--gold); }
    .type-item-score { font-family: 'Cormorant Garamond', serif; font-size: 24px; color: var(--ink2); }
    .type-item.top .type-item-score { color: var(--gold); }
    .type-item-desc { font-size: 14px; color: var(--ink2); line-height: 1.6; }

    .result-btns { display: flex; gap: 12px; justify-content: center; }
    .btn-restart { background: var(--gold); border: none; color: #fff; font-family: 'Noto Serif KR', serif; font-size: 15px; padding: 14px 32px; cursor: pointer; transition: opacity 0.2s; }
    .btn-restart:hover { opacity: 0.85; }

    /* 관리자 */
    .admin-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 9999; overflow-y: auto; padding: 40px 20px; }
    .admin-content { max-width: 900px; margin: 0 auto; background: var(--bg); padding: 32px; }
    .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .admin-header h3 { font-family: 'Cormorant Garamond', serif; font-size: 36px; color: var(--gold); }
    .btn-close { background: var(--ink); border: none; color: #fff; padding: 10px 20px; cursor: pointer; }
    .admin-table { width: 100%; border-collapse: collapse; }
    .admin-table th { background: var(--gold); color: #fff; padding: 12px; text-align: left; }
    .admin-table td { border-bottom: 1px solid var(--border); padding: 12px; }
    .admin-table .expired { opacity: 0.4; }
    .btn-delete { background: #d9534f; border: none; color: #fff; padding: 6px 14px; cursor: pointer; font-size: 12px; }

    /* 애니메이션 */
    @keyframes fadeDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    .hidden { display: none !important; }

    @media (max-width: 640px) {
      .intro-cards { grid-template-columns: repeat(2, 1fr); }
      .q-options { flex-direction: column; }
      .result-btns { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="top-bar"></div>

  <!-- 관리자 모달 -->
  <div class="admin-modal" id="adminModal">
    <div class="admin-content">
      <div class="admin-header">
        <h3>관리자 모드</h3>
        <button class="btn-close" onclick="closeAdmin()">닫기</button>
      </div>
      <div id="adminList"></div>
    </div>
  </div>

  <div class="container">
    <!-- 헤더 -->
    <div class="header">
      <div class="header-eyebrow">Holland Code Assessment</div>
      <h1 onclick="adminClick()">Career<span>.</span></h1>
      <div class="header-rule"></div>
      <div class="header-sub">진로 · 직업 성향 분석</div>
    </div>

    <!-- 1단계: 이름 입력 -->
    <div id="step1">
      <div class="intro-cards">
        <div class="intro-card">
          <div class="intro-card-num">60</div>
          <div class="intro-card-title">Questions</div>
          <p>6가지 유형을<br>탐색합니다</p>
        </div>
        <div class="intro-card">
          <div class="intro-card-num">10</div>
          <div class="intro-card-title">Per Type</div>
          <p>유형당 10개<br>문항 배치</p>
        </div>
        <div class="intro-card">
          <div class="intro-card-num">5</div>
          <div class="intro-card-title">Scale</div>
          <p>5점 척도로<br>측정합니다</p>
        </div>
        <div class="intro-card">
          <div class="intro-card-num">3</div>
          <div class="intro-card-title">Days</div>
          <p>3일간 결과<br>보관됩니다</p>
        </div>
      </div>

      <div class="name-section">
        <div class="section-label">Your Name</div>
        <div class="name-row">
          <input type="text" id="nameInput" class="name-input" placeholder="이름을 입력하세요">
          <button class="btn-search" onclick="searchName()">검색</button>
        </div>
      </div>

      <div id="confirmBox" class="confirm-box hidden">
        <p id="confirmMsg"></p>
        <div class="confirm-btns">
          <button class="btn-yes" onclick="proceedNew()">새로 응답하기</button>
          <button class="btn-no" onclick="showExisting()">이전 결과 보기</button>
        </div>
      </div>
    </div>

    <!-- 2단계: 문항 -->
    <div id="step2" class="hidden">
      <div class="progress-wrap">
        <div class="progress-bar-bg">
          <div class="progress-bar-fill" id="progressFill"></div>
        </div>
        <div class="progress-text" id="progressText">0 / 60</div>
      </div>

      <div class="questions-header">
        <div class="questions-header-line"></div>
        <div class="questions-header-text">Assessment</div>
        <div class="questions-header-line"></div>
      </div>

      <div id="questionsContainer"></div>

      <div class="submit-wrap">
        <button class="btn-submit" id="submitBtn" onclick="submitAnswers()" disabled>결과 확인</button>
      </div>
    </div>

    <!-- 3단계: 결과 -->
    <div id="step3" class="hidden">
      <div class="result-header">
        <h2>Your<br><span>Result</span></h2>
        <div class="result-header-rule"></div>
        <div class="result-name" id="resultName"></div>
      </div>

      <div class="chart-box">
        <div class="chart-title">Type Distribution</div>
        <canvas id="resultChart"></canvas>
      </div>

      <div class="type-list" id="typeList"></div>

      <div class="result-btns">
        <button class="btn-restart" onclick="restart()">다시 하기</button>
      </div>
    </div>
  </div>

  <script>
    // ⭐ Firebase Functions URL - 실제 배포 URL로 변경하세요
    const FN = "https://us-central1-career-aptitude-test-b7b2c.cloudfunctions.net";

    let questions = [];
    let answers = {};
    let currentName = "";
    let existingResult = null;

    // API 호출
    async function api(endpoint, body = null) {
      const options = body ? {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      } : {};
      const res = await fetch(`${FN}/${endpoint}`, options);
      if (!res.ok) throw new Error(`API 오류: ${res.status}`);
      return res.json();
    }

    // 1단계: 이름 검색
    async function searchName() {
      const name = document.getElementById("nameInput").value.trim();
      if (!name) return alert("이름을 입력하세요.");
      
      currentName = name;
      try {
        const data = await api("searchResult", { name });
        if (data.found) {
          existingResult = data.result;
          document.getElementById("confirmMsg").innerText = 
            `"${name}"님의 기존 결과가 있습니다.\n새로 응답하시겠습니까, 아니면 이전 결과를 보시겠습니까?`;
          document.getElementById("confirmBox").classList.remove("hidden");
        } else {
          proceedNew();
        }
      } catch (e) {
        alert("오류: " + e.message);
      }
    }

    // 새로 응답
    async function proceedNew() {
      document.getElementById("step1").classList.add("hidden");
      document.getElementById("step2").classList.remove("hidden");
      try {
        const data = await api("getQuestions");
        questions = data.questions;
        renderQuestions();
      } catch (e) {
        alert("문항 로딩 실패: " + e.message);
      }
    }

    // 이전 결과 보기
    function showExisting() {
      if (!existingResult) return;
      displayResult(existingResult);
      document.getElementById("step1").classList.add("hidden");
      document.getElementById("step3").classList.remove("hidden");
    }

    // 문항 렌더링
    function renderQuestions() {
      const container = document.getElementById("questionsContainer");
      container.innerHTML = "";
      
      questions.forEach((q, idx) => {
        const card = document.createElement("div");
        card.className = "q-card";
        card.innerHTML = `
          <div class="q-num">Question ${idx + 1}</div>
          <div class="q-text">${q.text}</div>
          <div class="q-options">
            <div class="q-option" onclick="selectOption('${q.id}', 1, this)">${q.select1}</div>
            <div class="q-option" onclick="selectOption('${q.id}', 2, this)">${q.select2}</div>
            <div class="q-option" onclick="selectOption('${q.id}', 3, this)">${q.select3}</div>
            <div class="q-option" onclick="selectOption('${q.id}', 4, this)">${q.select4}</div>
            <div class="q-option" onclick="selectOption('${q.id}', 5, this)">${q.select5}</div>
          </div>
        `;
        container.appendChild(card);
      });

      updateProgress();
    }

    // 선택지 클릭
    function selectOption(qid, score, elem) {
      // 같은 문항의 다른 선택 해제
      const parent = elem.parentElement;
      parent.querySelectorAll(".q-option").forEach(opt => opt.classList.remove("selected"));
      elem.classList.add("selected");
      
      answers[qid] = score;
      updateProgress();
    }

    // 진행률 업데이트
    function updateProgress() {
      const answered = Object.keys(answers).length;
      const total = questions.length;
      const percent = (answered / total) * 100;
      
      document.getElementById("progressFill").style.transform = `scaleX(${percent / 100})`;
      document.getElementById("progressText").innerText = `${answered} / ${total}`;
      document.getElementById("submitBtn").disabled = (answered < total);
    }

    // 제출
    async function submitAnswers() {
      if (Object.keys(answers).length < questions.length) {
        return alert("모든 문항에 답해주세요.");
      }

      try {
        const data = await api("submitAnswers", { name: currentName, answers });
        displayResult(data.result);
        document.getElementById("step2").classList.add("hidden");
        document.getElementById("step3").classList.remove("hidden");
      } catch (e) {
        alert("제출 실패: " + e.message);
      }
    }

    // 결과 표시
    function displayResult(result) {
      document.getElementById("resultName").innerText = result.name + "님의 결과";

      // 차트
      const ctx = document.getElementById("resultChart").getContext("2d");
      new Chart(ctx, {
        type: "radar",
        data: {
          labels: ["현실적 실용형", "논리적 분석형", "창의적 예술형", "인간 중심 사회형", "주도적 리더형", "체계적 규범형"],
          datasets: [{
            label: "점수",
            data: [
              result.typeScores["현실적 실용형"] || 0,
              result.typeScores["논리적 분석형"] || 0,
              result.typeScores["창의적 예술형"] || 0,
              result.typeScores["인간 중심 사회형"] || 0,
              result.typeScores["주도적 리더형"] || 0,
              result.typeScores["체계적 규범형"] || 0
            ],
            backgroundColor: "rgba(184, 144, 58, 0.2)",
            borderColor: "rgba(184, 144, 58, 1)",
            borderWidth: 2
          }]
        },
        options: {
          scales: { r: { beginAtZero: true, max: 50 } },
          plugins: { legend: { display: false } }
        }
      });

      // 유형 리스트
      const list = document.getElementById("typeList");
      list.innerHTML = "";
      
      const types = [
        { name: result.firstType, score: result.firstScore, rank: 1 },
        { name: result.secondType, score: result.secondScore, rank: 2 },
        { name: result.thirdType, score: result.thirdScore, rank: 3 }
      ];

      types.forEach(t => {
        const item = document.createElement("div");
        item.className = "type-item" + (t.rank === 1 ? " top" : "");
        item.innerHTML = `
          <div class="type-item-header">
            <div class="type-item-name">${t.rank}위 · ${t.name}</div>
            <div class="type-item-score">${t.score}점</div>
          </div>
          <div class="type-item-desc">${result.descriptions[t.name]}</div>
        `;
        list.appendChild(item);
      });
    }

    // 다시 하기
    function restart() {
      location.reload();
    }

    // 관리자
    let adminClickCount = 0;
    function adminClick() {
      adminClickCount++;
      if (adminClickCount === 3) {
        const pw = prompt("관리자 비밀번호");
        if (pw) openAdmin(pw);
        adminClickCount = 0;
      }
      setTimeout(() => adminClickCount = 0, 1500);
    }

    async function openAdmin(pw) {
      try {
        const data = await api("adminGetAll", { password: pw });
        document.getElementById("adminModal").style.display = "block";
        
        const list = document.getElementById("adminList");
        if (!data.results.length) {
          list.innerHTML = "<p>결과가 없습니다.</p>";
          return;
        }

        let html = "<table class='admin-table'><tr><th>이름</th><th>1위</th><th>점수</th><th>시간</th><th>삭제</th></tr>";
        data.results.forEach(r => {
          const expired = r.expired ? " expired" : "";
          html += `<tr class="${expired}">
            <td>${r.name}</td>
            <td>${r.firstType}</td>
            <td>${r.firstScore}</td>
            <td>${r.timeStr}</td>
            <td><button class="btn-delete" onclick="deleteResult('${r.id}', '${pw}')">삭제</button></td>
          </tr>`;
        });
        html += "</table>";
        list.innerHTML = html;
      } catch (e) {
        alert("인증 실패: " + e.message);
      }
    }

    function closeAdmin() {
      document.getElementById("adminModal").style.display = "none";
    }

    async function deleteResult(id, pw) {
      if (!confirm("삭제하시겠습니까?")) return;
      try {
        await api("adminDelete", { password: pw, id });
        alert("삭제되었습니다.");
        openAdmin(pw);
      } catch (e) {
        alert("삭제 실패: " + e.message);
      }
    }
  </script>
</body>
</html>
